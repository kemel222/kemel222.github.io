<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>С годовщиной, любимая!</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
            color: #333;
        }

        #heart-canvas {
            margin-bottom: 5vh;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
            width: 70vw;
            height: 70vw;
            max-width: 300px;
            max-height: 300px;
        }

        #message {
            text-align: center;
            max-width: 90%;
            font-size: 1.2em;
            line-height: 1.5;
            margin-bottom: 5vh;
            opacity: 0; /* Скрыто изначально */
        }

        #invitation {
            text-align: center;
            max-width: 90%;
            font-size: 1.1em;
            line-height: 1.5;
            margin: 3vh 0;
            font-style: italic;
            color: #ff4757;
            opacity: 0; /* Скрыто изначально */
        }

        .letter {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #signature {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #ff4757;
            margin-bottom: 2vh;
            opacity: 0; /* Скрыто изначально */
            transition: opacity 1s ease-out; /* Для fade out */
        }

        #signature-canvas {
            margin-bottom: 2vh;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.3);
            width: 70vw;
            height: 20vh;
            max-width: 300px;
            max-height: 100px;
            opacity: 0; /* Скрыто изначально, появится после fade out текста */
        }

        #date {
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }

        /* Адаптация под iPhone 15 (viewport 393x852 CSS px) */
        @media (max-width: 393px) {
            #heart-canvas {
                width: 250px !important;
                height: 250px !important;
            }
            #signature-canvas {
                width: 250px !important;
                height: 80px !important;
            }
            #message, #invitation {
                font-size: 1em;
            }
            #signature {
                font-size: 1.1em;
            }
            #date {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <canvas id="heart-canvas" width="300" height="300"></canvas>

    <div id="message">
        <p>С годовщиной нашей любви, моя любимая, моя солнышко!</p>
        <p>Эти последние полгода были невероятно сложными для нас обоих, моя дорогая. Наше отношение друг к другу иногда было просто отвратительным, и мы оба так сильно страдали от этого. Но ты — самая лучшая и самая нежная в мире, несмотря на все трудности. Ты всегда в моем сердце, моя милая, и я бесконечно горжусь твоей силой и красотой души.</p>
        <p>Пожалуйста, прости меня за всю мою лишнюю агрессию, плохое поведение, то, что я тебя сильно разочаровывал, и особенно за то, что я врал тебе. Я так жалею об этом, моя любимая.</p>
        <p>Я тебя сильно люблю, моя сладкая, и всегда буду рядом, обнимая тебя крепко-крепко.</p>
    </div>

    <div id="invitation">
        <p>Моя дорогая Софа, позволь мне пригласить тебя на волшебный вечер, чтобы отметить нашу годовщину. Заберу тебя в 19:00 — надень то платье, в котором ты сияешь ярче звезд, и позволь нашему сердцу биться в унисон под луной. С нетерпением жду этого момента. Твой Максим.</p>
    </div>

    <div id="signature">Софа + Максим</div>
    <canvas id="signature-canvas" width="300" height="100"></canvas>
    <div id="date">11/10/2024</div>

    <script>
        // Время сборки сердца
        const assembleDuration = 3000; // 3 секунды

        // Уменьшаем задержку на букву для ускорения (0.05s вместо 0.1s, межабзац 0.2s вместо 0.3s)
        const letterDelay = 0.05;
        const paragraphDelay = 0.2;

        // Функция для анимации текста, возвращает Promise с временем завершения
        function animateText(element, startDelay = 0) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const textElements = element.querySelectorAll('p');
                    let totalTime = 0;
                    textElements.forEach((el, paraIndex) => {
                        const letters = el.textContent.split('');
                        el.innerHTML = '';
                        letters.forEach((letter, i) => {
                            const span = document.createElement('span');
                            span.className = 'letter';
                            span.textContent = letter === ' ' ? '\u00A0' : letter;
                            span.style.animationDelay = (totalTime + i * letterDelay) + 's';
                            el.appendChild(span);
                        });
                        totalTime += (letters.length * letterDelay) + (paraIndex > 0 ? paragraphDelay : 0);
                    });
                    element.style.opacity = 1;
                    const fullDuration = totalTime + 0.5;
                    setTimeout(resolve, fullDuration * 1000);
                }, startDelay);
            });
        }

        // Анимация подписи как текст с fade out
        function animateSignature(startDelay = 0) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const el = document.getElementById('signature');
                    const letters = el.textContent.split('');
                    el.innerHTML = '';
                    letters.forEach((letter, i) => {
                        const span = document.createElement('span');
                        span.className = 'letter';
                        span.textContent = letter === ' ' ? '\u00A0' : letter;
                        span.style.animationDelay = (i * letterDelay) + 's';
                        el.appendChild(span);
                    });
                    el.style.opacity = 1;
                    const fullDuration = (letters.length * letterDelay) + 0.5;
                    setTimeout(() => {
                        // Fade out после показа (2 секунды задержки, затем 1s fade out)
                        setTimeout(() => {
                            el.style.opacity = 0;
                            // После fade out показываем canvas и стартуем анимацию сердечка
                            setTimeout(() => {
                                document.getElementById('signature-canvas').style.opacity = 1;
                                sigAnimationStart = Date.now();
                                resolve();
                            }, 1000); // После fade out
                        }, 2000); // Держим текст 2 секунды
                    }, fullDuration * 1000);
                }, startDelay);
            });
        }

        // Запуск анимации основного текста после сборки сердца
        const mainTextPromise = animateText(document.getElementById('message'), assembleDuration);

        // Запуск приглашения после полного отображения основного текста
        mainTextPromise.then(() => {
            const invitationPromise = animateText(document.getElementById('invitation'), 0);
            // После приглашения анимируем подпись текста с fade out и сердечком
            invitationPromise.then(() => {
                animateSignature(0);
            });
        });

        // Canvas анимация основного сердца
        const heartCanvas = document.getElementById('heart-canvas');
        const heartCtx = heartCanvas.getContext('2d');
        let heartCenterX = heartCanvas.width / 2;
        let heartCenterY = heartCanvas.height / 2;
        const heartSize = 120;

        const heartPoints = [];
        const numHeartPoints = 200;
        for (let i = 0; i < numHeartPoints; i++) {
            const t = (i / numHeartPoints) * 2 * Math.PI;
            let x = 16 * Math.pow(Math.sin(t), 3);
            let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
            x *= 0.9;
            y *= 0.85;
            heartPoints.push({
                targetX: heartCenterX + x * (heartSize / 16),
                targetY: heartCenterY + y * (heartSize / 13),
                x: Math.random() * heartCanvas.width,
                y: Math.random() * heartCanvas.height,
                opacity: 0,
                twinkle: Math.random() * Math.PI * 2
            });
        }

        let heartAnimationStart = Date.now();
        const twinkleDuration = 2000;

        function drawHeart() {
            const elapsed = Date.now() - heartAnimationStart;
            const progress = Math.min(elapsed / assembleDuration, 1);

            heartCtx.clearRect(0, 0, heartCanvas.width, heartCanvas.height);

            heartPoints.forEach((point) => {
                if (progress < 1) {
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    point.x += (point.targetX - point.x) * 0.08 * easeProgress;
                    point.y += (point.targetY - point.y) * 0.08 * easeProgress;
                    point.opacity = easeProgress;
                } else {
                    const twinkleTime = (elapsed - assembleDuration) % twinkleDuration;
                    const twinkleProgress = Math.sin(twinkleTime / 1000 * Math.PI * 2) * 0.5 + 0.5;
                    point.opacity = 0.8 + 0.2 * twinkleProgress;
                }

                const gradient = heartCtx.createRadialGradient(point.x, point.y, 0, point.x, point.y, 8);
                gradient.addColorStop(0, `rgba(255, 71, 87, ${point.opacity})`);
                gradient.addColorStop(1, `rgba(255, 71, 87, 0)`);

                heartCtx.fillStyle = gradient;
                heartCtx.beginPath();
                heartCtx.arc(point.x, point.y, 2.5, 0, 2 * Math.PI);
                heartCtx.fill();

                heartCtx.shadowColor = '#ff4757';
                heartCtx.shadowBlur = point.opacity * 15;
            });

            heartCtx.shadowBlur = 0;
            requestAnimationFrame(drawHeart);
        }

        // Анимация сердечка на canvas для подписи (только сборка и мерцание, без текста/взрыва)
        const sigCanvas = document.getElementById('signature-canvas');
        const sigCtx = sigCanvas.getContext('2d');
        let sigCenterX = sigCanvas.width / 2;
        let sigCenterY = sigCanvas.height / 2;
        const smallHeartSize = 40;

        const smallHeartPoints = [];
        for (let i = 0; i < 50; i++) {
            const t = (i / 50) * 2 * Math.PI;
            let x = 16 * Math.pow(Math.sin(t), 3) * 0.6;
            let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t)) * 0.6;
            smallHeartPoints.push({
                targetX: sigCenterX + x * (smallHeartSize / 16),
                targetY: sigCenterY + y * (smallHeartSize / 13),
                x: Math.random() * sigCanvas.width,
                y: Math.random() * sigCanvas.height,
                opacity: 0,
                twinkle: Math.random() * Math.PI * 2
            });
        }

        let sigAnimationStart = null;
        const heartAssembleDuration = 2000; // Сборка сердечка

        function drawSignatureHeart() {
            if (!sigAnimationStart) {
                requestAnimationFrame(drawSignatureHeart);
                return;
            }

            const elapsed = Date.now() - sigAnimationStart;
            const progress = Math.min(elapsed / heartAssembleDuration, 1);

            sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);

            smallHeartPoints.forEach((point) => {
                if (progress < 1) {
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    point.x += (point.targetX - point.x) * 0.1 * easeProgress;
                    point.y += (point.targetY - point.y) * 0.1 * easeProgress;
                    point.opacity = easeProgress;
                } else {
                    const twinkleTime = (elapsed - heartAssembleDuration) % twinkleDuration;
                    const twinkleProgress = Math.sin(twinkleTime / 1000 * Math.PI * 2) * 0.5 + 0.5;
                    point.opacity = 0.8 + 0.2 * twinkleProgress;
                }

                const gradient = sigCtx.createRadialGradient(point.x, point.y, 0, point.x, point.y, 5);
                gradient.addColorStop(0, `rgba(255, 71, 87, ${point.opacity})`);
                gradient.addColorStop(1, `rgba(255, 71, 87, 0)`);

                sigCtx.fillStyle = gradient;
                sigCtx.beginPath();
                sigCtx.arc(point.x, point.y, 1.5, 0, 2 * Math.PI);
                sigCtx.fill();

                sigCtx.shadowColor = '#ff4757';
                sigCtx.shadowBlur = point.opacity * 10;
            });

            sigCtx.shadowBlur = 0;
            requestAnimationFrame(drawSignatureHeart);
        }

        // Адаптация canvas размеров под устройство
        function resizeCanvases() {
            const viewportWidth = window.innerWidth;
            let heartSizePx = Math.min(viewportWidth * 0.7, 300);
            if (viewportWidth <= 393) { // iPhone 15
                heartSizePx = 250;
            }
            heartCanvas.style.width = `${heartSizePx}px`;
            heartCanvas.style.height = `${heartSizePx}px`;
            heartCanvas.width = heartSizePx;
            heartCanvas.height = heartSizePx;
            heartCenterX = heartCanvas.width / 2;
            heartCenterY = heartCanvas.height / 2;
            // Пересчитать target позиции сердца
            heartPoints.forEach((point, i) => {
                const t = (i / numHeartPoints) * 2 * Math.PI;
                let x = 16 * Math.pow(Math.sin(t), 3) * 0.9;
                let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t)) * 0.85;
                point.targetX = heartCenterX + x * (heartSize / 16);
                point.targetY = heartCenterY + y * (heartSize / 13);
            });

            let sigSizePx = Math.min(viewportWidth * 0.7, 300);
            let sigHeightPx = Math.min(viewportWidth * 0.2, 100);
            if (viewportWidth <= 393) {
                sigSizePx = 250;
                sigHeightPx = 80;
            }
            sigCanvas.style.width = `${sigSizePx}px`;
            sigCanvas.style.height = `${sigHeightPx}px`;
            sigCanvas.width = sigSizePx;
            sigCanvas.height = sigHeightPx;
            sigCenterX = sigCanvas.width / 2;
            sigCenterY = sigCanvas.height / 2;
            // Пересчитать маленькое сердце
            smallHeartPoints.forEach((point, i) => {
                const t = (i / 50) * 2 * Math.PI;
                let x = 16 * Math.pow(Math.sin(t), 3) * 0.6;
                let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t)) * 0.6;
                point.targetX = sigCenterX + x * (smallHeartSize / 16);
                point.targetY = sigCenterY + y * (smallHeartSize / 13);
            });
        }

        window.addEventListener('resize', resizeCanvases);
        resizeCanvases();

        drawHeart();
        drawSignatureHeart();
    </script>
</body>
</html>